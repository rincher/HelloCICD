name: Build & Deploy to ECS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1           # 사용할 AWS 리전
  ECR_REPOSITORY: helloapp        # ECR 리포지토리 이름
  ECS_CLUSTER: hellocluster       # ECS 클러스터 이름
  ECS_SERVICE: helloservice       # ECS 서비스 이름
  # Task Definition 이름을 “family” 또는 전체 ARN으로 설정
  ECS_TASK_DEFINITION: hellotask   # 기존에 등록된 Task Definition family name
  CONTAINER_NAME: helloapp        # Task Definition 내 컨테이너 이름

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) JDK 설치 및 Gradle 캐시
      - name: Set up JDK 17 and cache Gradle
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      # 3) AWS 자격 증명 설정
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/githuboidc # replace with your IAM Role ARN
          aws-region: ${{ env.AWS_REGION }}

      # 4) ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 5) 애플리케이션 빌드
      - name: Build with Gradle
        run: ./gradlew clean build

      # 6) Docker 이미지 빌드·태그·푸시
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG:    ${{ github.sha }}
          SERVICE_PATH: .
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG $SERVICE_PATH
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 7) 기존 Task Definition 조회 및 새 이미지로 업데이트
      - name: Register new task definition
        id: register-task-def
        run: |
          # 기존 task definition 조회
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query 'taskDefinition' \
            --output json > task-definition.json
          
          # 불필요한 필드 제거 및 이미지 업데이트
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy) | 
              .containerDefinitions[0].image = "${{ steps.build-image.outputs.image }}"' \
              task-definition.json > new-task-definition.json
          
          # 새 task definition 등록
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task_def_arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

      # 8) ECS 서비스 업데이트 (Built-in Blue/Green 트리거)
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task-def.outputs.task_def_arn }}
